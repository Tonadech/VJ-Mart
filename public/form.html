<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body >
  <div class="container py-5">
    <h2 class="mb-3">üìã ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>

    <form id="expenseForm" class="row g-3" enctype="multipart/form-data">
      <input type="hidden" name="docId">
      <div class="col-12">
        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
        <select class="form-select" name="entryType">
          <option value="expense">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="recurring">Recurring</option>
        </select>
      </div>
      <div id="recurringFields" class="row g-3 d-none">
        <div class="col-md-4">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
          <input type="date" name="nextDate" class="form-control">
        </div>
        <div class="col-md-4">
          <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
          <select name="frequencyUnit" class="form-select" required>
            <option value="days">‡∏ß‡∏±‡∏ô</option>
            <option value="weeks">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
            <option value="months">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
            <option value="years">‡∏õ‡∏µ</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (‡∏ß‡∏±‡∏ô)</label>
          <input type="number" name="frequency" class="form-control">
        </div>
        <!-- <div class="col-md-4">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
          <input type="number" name="repeatCount" class="form-control">
        </div> -->
      </div>
      <!-- <div class="col-md-4"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label><input type="date" name="nextDate" class="form-control"></div>
      <div class="col-md-4"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (‡∏ß‡∏±‡∏ô)</label><input type="number" name="frequency" class="form-control"></div>
      <div class="col-md-4"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label><input type="number" name="repeatCount" class="form-control"></div> -->
      <input type="hidden" name="docId" />
      <div class="col-md-3"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" name="item" class="form-control"></div>
      <div class="col-md-3"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" name="date" class="form-control" required></div>
      <div class="col-md-6 d-none"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text" name="employee" class="form-control" readonly></div>
      <div class="col-md-6 d-none"><label>Role</label><input type="text" name="role" class="form-control" ></div>
      <div class="col-md-6 d-none">
      <label>UID</label>
        <input type="text" name="uid" id="uid" class="form-control" readonly>
      </div>

      <div class="col-md-6 d-none">
        <label>Admin Leader</label>
        <input type="text" name="adminleader" id="adminleader" class="form-control" readonly>
      </div>
      <div class="col-md-6 d-none"><label>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label><input type="text" name="company" class="form-control" readonly></div>
      <div class="col-md-6 d-none"><label>‡πÅ‡∏ú‡∏ô‡∏Å</label><input type="text" name="division" class="form-control" readonly></div>
      <div class="col-md-3"><label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><input type="text" name="bank" class="form-control"></div>
      <div class="col-md-3"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><input type="text" name="accountNumber" class="form-control"></div>
      <div class="col-md-3"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><input type="text" name="accountName" class="form-control"></div>
      <div class="col-md-3"><label>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</label><input type="number" name="amount" class="form-control"></div>
      <div class="col-md-3">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label>
        <select name="expenseType" class="form-select">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
          <option value="‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option value="PO">PO</option>
          <option value="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
          <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div class="col-md-6 d-none"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><input type="text" name="status" class="form-control" ></div>
      <!-- <div class="col-md-3"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</label><input type="text" name="completeness" class="form-control"></div>
      <div class="col-md-3"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</label><input type="text" name="assetType" class="form-control"></div>
      <div class="col-md-9"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" name="note" class="form-control"></div> -->

      <div class="col-12">
        <label>‡πÑ‡∏ü‡∏•‡πå INV PDF</label>
        <input type="file" name="invPdf" class="form-control" accept=".pdf"/>
      </div>
      <div class="col-12">
        <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û INV</label>
        <input type="file" name="invImg" class="form-control" accept="image/*"/>
      </div>
      <div class="col-12">
        <label>‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="file" name="invPdfEmployee" class="form-control" accept=".pdf"/>
      </div>
      <div class="col-12">
        <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input type="file" name="invImgEmployee" class="form-control" accept="image/*"/>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-success">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </form>
  </div>

  <!-- <script type="module" >
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc ,Timestamp , doc, getDoc,updateDoc  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcL-j2Em-8q0Wvg-flOTssxQT4XlWqXzE",
      authDomain: "bill-for--vj-mart.firebaseapp.com",
      projectId: "bill-for--vj-mart",
      storageBucket: "bill-for--vj-mart.appspot.com",
      messagingSenderId: "700824685931",
      appId: "1:700824685931:web:856b3880c0496b5fd1902e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    function getDocIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("docId");
    }


    async function loadExpenseData(docId) {
      if (!docId) return;
      const docRef = doc(db, "expenses", docId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ");
        return;
      }
      const data = docSnap.data();

      // ‡πÅ‡∏õ‡∏•‡∏á timestamp
      if (data.date?.toDate) {
        data.date = data.date.toDate().toISOString().split("T")[0];
      }
      if (data.nextDate?.toDate) {
        data.nextDate = data.nextDate.toDate().toISOString().split("T")[0];
      }

      // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà docId ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ form
      document.querySelector('input[name="docId"]').value = docId;

      populateForm(data);
    }


    function populateForm(data) {
      const form = document.getElementById("expenseForm");
      if (!form) return;

      for (const key in data) {
        const input = form.elements[key];
        console.log("üí° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ã‡πá‡∏ï item:", data.item);
        form.elements["item"].value = data.item || "";       
        if (input && input.type !== "file") {
          if (data[key]?.toDate) {
            input.value = data[key].toDate().toISOString().split("T")[0];  // ‡πÅ‡∏õ‡∏•‡∏á timestamp ‡πÄ‡∏õ‡πá‡∏ô date string
          } else {
            input.value = data[key];
          }
        }
      }

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ recurringFields ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô
      if (data.entryType === "recurring") {
        document.getElementById("recurringFields").classList.remove("d-none");
      } else {
        document.getElementById("recurringFields").classList.add("d-none");
      }
    }
    window.addEventListener("DOMContentLoaded",async  () => {
      // Step 1: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏à‡∏≤‡∏Å localStorage
      const user = JSON.parse(localStorage.getItem("user"));
      const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
      if (!user) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        window.location.href = "index.html"; // ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ login
        return;
      }

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
      
      document.querySelector('input[name="employee"]').value = user.name || "";
      document.querySelector('input[name="role"]').value = user.role || "";
      document.querySelector('input[name="division"]').value = user.division || "";
      document.querySelector('input[name="company"]').value = user.company || "";
      document.querySelector('input[name="uid"]').value = user.uid || "";
      document.querySelector('input[name="adminleader"]').value = user.adminleader || user.name || "";
      
      const invPdfEmployeeInput = document.querySelector('input[name="invPdfEmployee"]');
      const invImgEmployeeInput = document.querySelector('input[name="invImgEmployee"]');
      const statusInput = document.querySelector('input[name="status"]');
      const urlParams = new URLSearchParams(window.location.search);
      const docId = urlParams.get("docId");
      console.log("üìå docId from URL:", docId);  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      if (docId) {
        const docRef = doc(db, "expenses", docId);
        try {
          const snap = await getDoc(docRef);
          if (snap.exists()) {
            const data = snap.data();
            for (const key in data) {
              const input = document.querySelector(`[name="${key}"]`);
              if (input && input.type !== "file") {
                input.value = data[key];
              }
            }
          } else {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£");
          }
        } catch (err) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
        }
        await loadExpenseData(docId);  // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ form
      }
      // if (docId) {
      //   const docRef = doc(db, "expenses", docId);
      //   try {
      //     const snap = await getDoc(docRef);
      //     if (snap.exists()) {
      //       const data = snap.data();
      //       for (const key in data) {
      //         const input = document.querySelector(`[name="${key}"]`);
      //         if (input && input.type !== "file") {
      //           input.value = data[key];
      //         }
      //       }
      //     } else {
      //       alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£");
      //     }
      //   } catch (err) {
      //     console.error("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      //     alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      //   }
      // }

      function updateStatus() {
        const hasPdf = invPdfEmployeeInput.files.length > 0;
        const hasImg = invImgEmployeeInput.files.length > 0;
        if (currentUser.role === "adminleader") {
          statusInput.value = "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
        }
        else if (hasPdf || hasImg) {
          statusInput.value = "‡πÇ‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô";
        } else {
          statusInput.value = "‡∏£‡∏≠‡∏ó‡∏≥‡πÄ‡∏ö‡∏¥‡∏Å";
        }
      }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
      invPdfEmployeeInput.addEventListener("change", updateStatus);
      invImgEmployeeInput.addEventListener("change", updateStatus);

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ autofill
      updateStatus();
      // Step 2: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ dropdown entryType ‡πÅ‡∏•‡∏∞ recurring fields
      const entryTypeSelect = document.querySelector('select[name="entryType"]');
      const recurringFields = document.getElementById("recurringFields");
      const dateInput = document.querySelector('input[name="date"]');
          if (dateInput) {
            const today = new Date().toISOString().split('T')[0]; // format YYYY-MM-DD
            dateInput.value = today;
          }      

      function toggleRecurringFields() {
      if (entryTypeSelect.value === "recurring") {
        recurringFields.classList.remove("d-none");
      } else {
        recurringFields.classList.add("d-none");
      }
      }
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
      toggleRecurringFields();
      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô select
      entryTypeSelect.addEventListener("change", toggleRecurringFields);
      // Step 3: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î event submit form
      expenseForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const docId = document.querySelector('input[name="docId"]').value?.trim() || null;

        try {
          const dataToUpdate = {};
          for (const [key, value] of formData.entries()) {
            if (!["invPdf", "invImg", "invPdfEmployee", "invImgEmployee"].includes(key)) {
              dataToUpdate[key] = value;
            }
          }

          if (docId) {
            // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
            const docRef = doc(db, "expenses", docId);
            await updateDoc(docRef, dataToUpdate);
          } else {
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ docId
            const expensesRef = collection(db, "expenses");
            const newDocRef = await addDoc(expensesRef, {
              ...dataToUpdate,
              timestamp: Timestamp.now(),
            });
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ docId ‡πÉ‡∏´‡πâ form ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
            document.querySelector('input[name="docId"]').value = newDocRef.id;
          }

          // ‚úÖ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ backend
          //const res = await fetch("/upload", {
          //  method: "POST",
           // body: formData,
          //});
          const res = await fetch("/api/expense", {
            method: "POST",//‡πÅ‡∏Å‡πâ‡πÉ‡∏ômac
            body: formData,
          });


          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || "Upload failed");
          }

          alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          window.location.href = "dashboard.html";
        } catch (err) {
          alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
          console.error(err);
        }
      });

      
        
    });
  </script> -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc ,Timestamp , doc, getDoc,updateDoc  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcL-j2Em-8q0Wvg-flOTssxQT4XlWqXzE",
      authDomain: "bill-for--vj-mart.firebaseapp.com",
      projectId: "bill-for--vj-mart",
      storageBucket: "bill-for--vj-mart.appspot.com",
      messagingSenderId: "700824685931",
      appId: "1:700824685931:web:856b3880c0496b5fd1902e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function getDocIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("docId");
    }

    async function loadExpenseData(docId) {
      if (!docId) return;
      const docRef = doc(db, "expenses", docId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ");
        return;
      }
      const data = docSnap.data();

      if (data.date?.toDate) {
        data.date = data.date.toDate().toISOString().split("T")[0];
      }
      if (data.nextDate?.toDate) {
        data.nextDate = data.nextDate.toDate().toISOString().split("T")[0];
      }

      document.querySelector('input[name="docId"]').value = docId;
      populateForm(data);
    }

    function populateForm(data) {
      const form = document.getElementById("expenseForm");
      if (!form) return;

      for (const key in data) {
        const input = form.elements[key];
        form.elements["item"].value = data.item || "";
        if (input && input.type !== "file") {
          if (data[key]?.toDate) {
            input.value = data[key].toDate().toISOString().split("T")[0];
          } else {
            input.value = data[key];
          }
        }
      }

      if (data.entryType === "recurring") {
        document.getElementById("recurringFields").classList.remove("d-none");
      } else {
        document.getElementById("recurringFields").classList.add("d-none");
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const user = JSON.parse(localStorage.getItem("user"));
      const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
      if (!user) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        window.location.href = "index.html";
        return;
      }

      document.querySelector('input[name="employee"]').value = user.name || "";
      document.querySelector('input[name="role"]').value = user.role || "";
      document.querySelector('input[name="division"]').value = user.division || "";
      document.querySelector('input[name="uid"]').value = user.uid || "";
      document.querySelector('input[name="company"]').value = user.company || "";
      document.querySelector('input[name="adminleader"]').value = user.adminleader || user.name || "";

      const invPdfEmployeeInput = document.querySelector('input[name="invPdfEmployee"]');
      const invImgEmployeeInput = document.querySelector('input[name="invImgEmployee"]');
      const statusInput = document.querySelector('input[name="status"]');
      const urlParams = new URLSearchParams(window.location.search);
      const docId = urlParams.get("docId");

      if (docId) {
        const docRef = doc(db, "expenses", docId);
        try {
          const snap = await getDoc(docRef);
          if (snap.exists()) {
            const data = snap.data();
            for (const key in data) {
              const input = document.querySelector(`[name="${key}"]`);
              if (input && input.type !== "file") {
                input.value = data[key];
              }
            }
          } else {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£");
          }
        } catch (err) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
        }
        await loadExpenseData(docId);
      }

      function updateStatus() {
        const hasPdf = invPdfEmployeeInput.files.length > 0;
        const hasImg = invImgEmployeeInput.files.length > 0;
        if (currentUser.role === "adminleader") {
          statusInput.value = "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
        } else if (hasPdf || hasImg) {
          statusInput.value = "‡πÇ‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô";
        } else {
          statusInput.value = "‡∏£‡∏≠‡∏ó‡∏≥‡πÄ‡∏ö‡∏¥‡∏Å";
        }
      }

      invPdfEmployeeInput.addEventListener("change", updateStatus);
      invImgEmployeeInput.addEventListener("change", updateStatus);
      updateStatus();

      const entryTypeSelect = document.querySelector('select[name="entryType"]');
      const recurringFields = document.getElementById("recurringFields");
      const dateInput = document.querySelector('input[name="date"]');
      if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }

      function toggleRecurringFields() {
        if (entryTypeSelect.value === "recurring") {
          recurringFields.classList.remove("d-none");
        } else {
          recurringFields.classList.add("d-none");
        }
      }
      toggleRecurringFields();
      entryTypeSelect.addEventListener("change", toggleRecurringFields);
      expenseForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const docId = document.querySelector('input[name="docId"]').value?.trim() || null;

        try {
          const dataToUpdate = {};
          for (const [key, value] of formData.entries()) {
            if (!["invPdf", "invImg", "invPdfEmployee", "invImgEmployee"].includes(key)) {
              dataToUpdate[key] = value;
            }
          }

          const entryType = formData.get("entryType");
          const collectionName = (entryType === "recurring") ? "recurring" : "expenses";

          // ‡∏ñ‡πâ‡∏≤ recurring ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà nextDate
          if (entryType === "recurring") {
            const frequency = parseInt(formData.get("frequency") || "0");
            const unit = formData.get("frequencyUnit");
            const today = new Date();
            let next = new Date(today);

            if (unit === "days") next.setDate(today.getDate() + frequency);
            else if (unit === "weeks") next.setDate(today.getDate() + frequency * 7);
            else if (unit === "months") next.setMonth(today.getMonth() + frequency);
            else if (unit === "years") next.setFullYear(today.getFullYear() + frequency);

            dataToUpdate.nextDate = next.toISOString().split("T")[0];
          }

          let finalDocId = docId;

          // üßæ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ docId ‚Üí ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô Firestore
          if (!finalDocId) {
            const collectionRef = collection(db, collectionName);
            const newDocRef = await addDoc(collectionRef, {
              ...dataToUpdate,
              timestamp: Timestamp.now(),
            });
            finalDocId = newDocRef.id;
            
          } 
          if (finalDocId) {
            const docRef = doc(db, collectionName, finalDocId);
            console.log("üìÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö docRef:", docRef.path);

            // üü° ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
            const docSnap = await getDoc(docRef);
            let existingData = {};
            if (docSnap.exists()) {
              existingData = docSnap.data();
              console.log("üì• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å Firestore:", existingData);
            } else {
              console.log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà)");
            }

            // üü° ‡πÉ‡∏™‡πà URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            const fileKeys = ["invPdfUrl", "invImgUrl", "invPdfEmployeeUrl", "invImgEmployeeUrl"];
            fileKeys.forEach((key) => {
              if (!(key in dataToUpdate) && key in existingData) {
                dataToUpdate[key] = existingData[key];
                console.log(`üîÅ ‡πÉ‡∏™‡πà URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö: ${key} = ${existingData[key]}`);
              }
            });
          }

          console.log("üì§ ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á /upload ‡∏û‡∏£‡πâ‡∏≠‡∏° docId:", finalDocId);
          formData.append("docId", finalDocId);

          const res = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            const text = await res.text();
            console.error("‚ùå Upload failed:", text);
            throw new Error(text || "Upload failed");
          }

          const uploadedUrls = await res.json(); // ‚Üê { invPdfUrl, invImgUrl, ... }
          console.log("‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö URL ‡∏à‡∏≤‡∏Å backend:", uploadedUrls);

          // üü¢ ‡∏£‡∏ß‡∏° URL ‡∏ó‡∏µ‡πà upload ‡∏°‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
          Object.assign(dataToUpdate, uploadedUrls);
          console.log("üßæ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore:", dataToUpdate);

          // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Firestore
          await updateDoc(doc(db, collectionName, finalDocId), dataToUpdate);
          console.log("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:", finalDocId);

          alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          window.location.href = "dashboard.html";


        } catch (err) {
          alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
          console.error(err);
        }
      });


      // expenseForm.addEventListener("submit", async function (e) {
      //   e.preventDefault();

      //   const formData = new FormData(this);
      //   const docId = document.querySelector('input[name="docId"]').value?.trim() || null;

      //   try {
      //     const dataToUpdate = {};
      //     for (const [key, value] of formData.entries()) {
      //       if (!["invPdf", "invImg", "invPdfEmployee", "invImgEmployee"].includes(key)) {
      //         dataToUpdate[key] = value;
      //       }
      //     }

      //     const entryType = formData.get("entryType");
      //     const collectionName = (entryType === "recurring") ? "recurring" : "expenses";

      //     if (entryType === "recurring") {
      //       const frequency = parseInt(formData.get("frequency") || "0");
      //       const unit = formData.get("frequencyUnit");
      //       const today = new Date();
      //       let next = new Date(today);

      //       if (unit === "days") next.setDate(today.getDate() + frequency);
      //       else if (unit === "weeks") next.setDate(today.getDate() + frequency * 7);
      //       else if (unit === "months") next.setMonth(today.getMonth() + frequency);
      //       else if (unit === "years") next.setFullYear(today.getFullYear() + frequency);

      //       dataToUpdate.nextDate = next.toISOString().split("T")[0];
      //     }

      //     if (docId) {
      //       const docRef = doc(db, collectionName, docId);
      //       await updateDoc(docRef, dataToUpdate);
      //     } else {
      //       const collectionRef = collection(db, collectionName);
      //       const newDocRef = await addDoc(collectionRef, {
      //         ...dataToUpdate,
      //         timestamp: Timestamp.now(),
      //       });
      //       document.querySelector('input[name="docId"]').value = newDocRef.id;
      //     }

      //     const res = await fetch("/upload", {
      //      method: "POST",
      //      body: formData,
      //     });
      //     // const res = await fetch("/api/expense", {
      //     //             method: "POST",//‡πÅ‡∏Å‡πâ‡πÉ‡∏ômac
      //     //             body: formData,
      //     //           });
      //     if (!res.ok) {
      //       const text = await res.text();
      //       throw new Error(text || "Upload failed");
      //     }

      //     alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      //     window.location.href = "dashboard.html";
      //   } catch (err) {
      //     alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      //     console.error(err);
      //   }
      // });
    });
    </script>



</body>
</html>

